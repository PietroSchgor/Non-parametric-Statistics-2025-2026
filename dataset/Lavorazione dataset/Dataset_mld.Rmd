---
title: "Mixed layer depth"
author: "Leo"
date: "2025-11-24"
output: html_document
---

### Cos'è fisicamente il "Mixed Layer" (Strato Rimescolato)?
Immagina la superficie del mare. Vento, onde e scambi di calore "frullano" continuamente i primi metri d'acqua. In questa zona superficiale, tutte le proprietà (temperatura, salinità, densità) sono omogenee (uguali). Questo è il Mixed Layer.

Sotto questo strato, l'acqua smette di essere mescolata, diventa improvvisamente più fredda e più densa. Il punto esatto in cui cambia bruscamente si chiama base del mixed layer.

mlotst è semplicemente il numero di metri dalla superficie fino a quel punto di cambiamento.


```{r caricamento dataset mld, message=FALSE, warning=FALSE}
# --- 1. Caricamento ---
library(terra)
library(tidyverse)
library(lubridate)

# Sostituisci con il nome del file MLD
nome_file <- "raw_mld_31052022_31052023.nc"
r <- rast(nome_file)

# Controllo: dovresti vedere nomi che iniziano con 'mlotst'
print(names(r)[1:5])

# --- 2. Ritaglio Area ---
# Stessa ROI: Alto Adriatico
roi <- ext(12, 14, 44, 46) 
r_crop <- crop(r, roi)

# --- 3. Conversione in DataFrame (WIDE) ---
df_wide <- as.data.frame(r_crop, xy = TRUE, na.rm = TRUE)

# --- 4. Pulizia Preventiva ---
# Teniamo solo le colonne che iniziano per 'mlotst' (più x e y)
# Questo evita problemi se il file ha variabili ausiliarie
df_wide_filtered <- df_wide %>%
  select(x, y, matches("^mlotst"))

# --- 5. Pivot Intelligente ---
# La regex ^([a-z]+) catturerà "mlotst"
# La regex ([0-9]+)$ catturerà l'indice temporale (1, 2, 3...)
df_long <- df_wide_filtered %>%
  pivot_longer(
    cols = -c(x, y),
    names_to = c(".value", "time_id"), 
    names_pattern = "^([a-z]+).*_([0-9]+)$" 
  ) %>%
  mutate(time_id = as.numeric(time_id))

# --- 6. Gestione Date ---
date_reali <- unique(time(r_crop))

mappa_date <- data.frame(
  time_id = 1:length(date_reali),
  Date = date_reali
)

# --- 7. Join Finale ---
dataset_statistico_mld <- df_long %>%
  left_join(mappa_date, by = "time_id") %>%
  rename(
    Lon = x, 
    Lat = y,
    MLD = mlotst # Rinominiamo in modo chiaro
  ) %>%
  select(Date, Lon, Lat, MLD)

# --- Controllo ---
head(dataset_statistico_mld)
summary(dataset_statistico_mld)
```

### Plot per il Mixed Layer Depth
Per il MLD, ti suggerisco un grafico specifico.
Il **Mixed Layer Depth** rappresenta la profondità (in metri) dello strato mescolato.
* Valori **bassi** (es. 10m) = Stratificazione estiva (acqua calda sopra, fredda sotto, alghe "intrappolate" senza nutrienti).
* Valori **alti** (es. 50-100m) = Mescolamento invernale (il vento rimescola tutto, portando nutrienti in superficie).

Usa la palette `mako` (blu profondo) invertita, così il blu scuro indica profondità maggiore.

```{r mappa media mld, message=FALSE, warning=FALSE}
# 1. Calcola la media MLD
mappa_media_mld <- dataset_statistico_mld %>%
  group_by(Lon, Lat) %>%
  summarise(Mean_MLD = mean(MLD, na.rm = TRUE))

# 2. Plot
ggplot(mappa_media_mld, aes(x = Lon, y = Lat, fill = Mean_MLD)) +
  geom_tile() +
  
  # 'mako' è una scala di blu ottima per la profondità.
  # direction = -1 inverte i colori: scuro = profondo (più intuitivo)
  scale_fill_viridis_c(
    option = "mako", 
    direction = -1,  
    name = "Metri"
  ) +
  
  coord_fixed(ratio = 1.3) +
  labs(
    title = "Profondità dello Strato Misto (Mixed Layer Depth)",
    subtitle = "Blu scuro = Mescolamento profondo | Chiaro = Stratificazione",
    x = "Longitudine",
    y = "Latitudine"
  ) +
  theme_minimal()
```