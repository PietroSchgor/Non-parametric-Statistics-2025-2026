---
title: "Dataset_salinità"
author: "Leo"
date: "2025-11-24"
output: html_document
---

```{r caricamento dataset salinita, message=FALSE, warning=FALSE}
# --- 1. Caricamento ---
library(terra)
library(tidyverse)
library(lubridate)

# Nome del file Salinità
nome_file <- "raw_salinita_31052022_31052023.nc"
r <- rast(nome_file)

# Controllo: dovresti vedere 'so' (Salinity) tra i nomi
print(names(r)[1:5])

# --- 2. Ritaglio Area (Alto Adriatico) ---
roi <- ext(12, 14, 44, 46) 
r_crop <- crop(r, roi)

# --- 3. Conversione in DataFrame (WIDE) ---
df_wide <- as.data.frame(r_crop, xy = TRUE, na.rm = TRUE)

# --- 4. Pivot Intelligente ---
# La regex ^([a-z]+) catturerà "so"
# La regex ([0-9]+)$ catturerà l'indice temporale
df_long <- df_wide %>%
  pivot_longer(
    cols = -c(x, y),
    names_to = c(".value", "time_id"), 
    names_pattern = "^([a-z]+).*_([0-9]+)$"
  ) %>%
  mutate(time_id = as.numeric(time_id))

# --- 5. Gestione Date ---
date_reali <- unique(time(r_crop))

mappa_date <- data.frame(
  time_id = 1:length(date_reali),
  Date = date_reali
)

# --- 6. Join Finale ---
dataset_statistico_sal <- df_long %>%
  left_join(mappa_date, by = "time_id") %>%
  rename(
    Lon = x, 
    Lat = y,
    Salinity = so  # Rinominiamo 'so' in 'Salinity'. Se la variabile ha un altro nome (es. vosaline), correggi qui.
  ) %>%
  select(Date, Lon, Lat, Salinity)

# --- Controllo ---
head(dataset_statistico_sal)
summary(dataset_statistico_sal)
```

Plot:
**Colori scuri (Bassa Salinità):** Vicino alla costa e alla foce del Po (l'acqua dolce abbassa la salinità).
**Colori chiari/Gialli (Alta Salinità):** Al largo, dove l'acqua è più "salata".
```{r mappa media salinita, message=FALSE, warning=FALSE}
# 1. Calcola la media Salinità
mappa_media_sal <- dataset_statistico_sal %>%
  group_by(Lon, Lat) %>%
  summarise(Mean_Sal = mean(Salinity, na.rm = TRUE))

# 2. Plot
ggplot(mappa_media_sal, aes(x = Lon, y = Lat, fill = Mean_Sal)) +
  geom_tile() +
  
  # 'cividis' è eccellente per la salinità e accessibile anche ai daltonici.
  # Alternativa: 'viridis' classica.
  scale_fill_viridis_c(
    option = "cividis", 
    name = "PSU" # Practical Salinity Unit
  ) +
  
  coord_fixed(ratio = 1.3) +
  labs(
    title = "Salinità Media Superficiale",
    subtitle = "Si nota l'acqua dolce del Po (bassa salinità) lungo la costa?",
    x = "Longitudine",
    y = "Latitudine"
  ) +
  theme_minimal()
```

Plot del primo giorno:
```{r mappa giorno salinita, message=FALSE, warning=FALSE}
# 1. Filtriamo solo il primo giorno
giorno_da_plottare <- min(dataset_statistico_sal$Date)

dati_giorno_sal <- dataset_statistico_sal %>%
  filter(Date == giorno_da_plottare)

# 2. Creiamo il Plot
ggplot(dati_giorno_sal, aes(x = Lon, y = Lat, fill = Salinity)) +
  geom_tile() +
  
  # --- STILE E COLORI ---
  # Uso 'cividis' (o 'viridis'). 
  # NOTA: Niente log10 qui!
  scale_fill_viridis_c(
    option = "cividis", 
    name = "PSU",
    direction = 1 
  ) +
  
  # --- COORDINATE ---
  coord_fixed(ratio = 1.3) +
  
  # --- TITOLI ---
  labs(
    title = paste("Mappa Salinità del", format(giorno_da_plottare, "%d %B %Y")),
    subtitle = "Dati Copernicus Reanalysis",
    x = "Longitudine",
    y = "Latitudine"
  ) +
  theme_minimal()
```

